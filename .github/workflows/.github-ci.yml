name: Build and Deploy

on:
  push:
    tags:
      - '*'
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      job_type:
        description: '選擇要執行的任務'
        required: true
        type: choice
        options:
          - build-and-push
          - run-container
        default: 'run-container'

jobs:
  build-and-push:
    # 在推送 tag 時或手動選擇 build-and-push 時執行
    if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'build-and-push')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      - name: Build with Maven
        run: mvn clean package -DskipTests
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract repository name
        id: repo
        run: echo "name=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          build-args: |
            FINAL_NAME=${{ github.sha }}
          tags: |
            ghcr.io/${{ steps.repo.outputs.name }}:latest
            ghcr.io/${{ steps.repo.outputs.name }}:${{ github.ref_name }}

  run-scheduled:
    # 在排程觸發時或手動選擇 run-container 時執行
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'run-container')
    runs-on: ubuntu-latest
    permissions:
      packages: read
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract repository name
        id: repo
        run: echo "name=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
      - name: Run Docker container
        run: |
          # 建立 Tor Dockerfile
          cat > Dockerfile.tor << 'EOF'
          FROM alpine:latest
          RUN apk add --no-cache tor
          RUN echo "SOCKSPort 0.0.0.0:9050" > /etc/tor/torrc && \
              echo "ExitNodes {tw}" >> /etc/tor/torrc && \
              echo "StrictNodes 0" >> /etc/tor/torrc && \
              echo "Log notice stdout" >> /etc/tor/torrc
          CMD ["tor", "-f", "/etc/tor/torrc"]
          EOF
          # 建置 Tor 容器映像
          echo "建置 Tor 容器..."
          docker build -f Dockerfile.tor -t local-tor .
          # 啟動 Tor 容器
          echo "啟動 Tor 容器..."
          docker run -d --name tor-proxy local-tor
          # 等待 Tor 完全啟動並建立電路
          echo "等待 Tor 建立電路..."
          sleep 60
          # 檢查 Tor 容器狀態
          echo "Tor 容器狀態:"
          docker ps | grep tor-proxy || docker ps -a | grep tor-proxy
          echo "Tor 日誌:"
          docker logs tor-proxy | tail -20
          # 測試 Tor 連線
          echo "測試 Tor 連線..."
          docker run --rm --network container:tor-proxy \
            curlimages/curl:latest \
            --socks5-hostname 127.0.0.1:9050 \
            https://api.ipify.org || echo "Tor 連線測試失敗"
          # 測試連線
          echo "測試 data.moi.gov.tw 連線…"
          curl -I --connect-timeout 10 https://data.moi.gov.tw || echo "連線失敗"
          # 執行應用容器
          echo "執行應用程式..."
          docker run --rm \
            --network container:tor-proxy \
            -e JAVA_TOOL_OPTIONS="-DsocksProxyHost=127.0.0.1 -DsocksProxyPort=9050" \
            ghcr.io/${{ steps.repo.outputs.name }}:latest || {
              echo "應用執行失敗,完整 Tor 日誌:"
              docker logs tor-proxy
              exit 1
            }
          # 清理 Tor 容器
          docker stop tor-proxy 2>/dev/null || true
          docker rm tor-proxy 2>/dev/null || true
          rm -f Dockerfile.tor
        continue-on-error: true
